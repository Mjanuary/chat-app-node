window.app = {
    themes: {
        list: [
            {
                image: '1234.jpg',
                colors: {
                    primary: '#333',
                    secondary: '#777',
                    text: '#34343',
                    background: 'image1.jpg'
                }
            },
            {
                image: '1234.jpg',
                colors: {
                    primary: '#333',
                    secondary: '#777',
                    text: '#34343',
                    background: 'image1.jpg'
                }
            },
            {
                image: '1234.jpg',
                colors: {
                    primary: '#333',
                    secondary: '#777',
                    text: '#34343',
                    background: 'image1.jpg'
                }
            },
        ],
        selected: '01'
    },
    state: {
        selectedTheme: 0,
        isRegistered: false,
    }
};

window.data = {
    selected: null,
    root: {
        profile: {
            firstName: "",
            lastName: "",
            email: "",
            phone: "",
            country: ""
        },
        posts: [
            {
                image: 'images/image1.jpg',
                caption: 'hahahahahhahahahahahha'
            },                {
                image: 'images/image1.jpg',
                caption: 'hahahahahhahahahahahha',
            },
        ]

    },
    friends: [
        {
            profile: {
                firstName: "Alice",
                lastName: "emerance",
                email: "alice@gmail.com",
                gender: "Female",
                picture: 'images (5).jpg'
            },
            chats: [
                {
                    by: 'friend',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      ,
                    image: 'images/black-black-watch-cellphone-1841841.jpg'
                },
                {
                    by: 'me',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      ,
                    image: 'images/black-black-watch-cellphone-1841841.jpg'
                },
                {
                    by: 'friend',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'friend',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'me',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                }
            ],
            posts: [
                {
                    image: 'images/image1.jpg',
                    caption: 'hahahahahhahahahahahha'
                },
                {
                    image: 'images/image2.jpg',
                    caption: 'hahahahahhahahahahahha'
                },
                {
                    image: 'images/image3.jpg',
                    caption: 'hahahahahhahahahahahha'
                }
        ]
        },
        {
            profile: {
                firstName: "Jonathan",
                lastName: "muhawenimana",
                email: "janviermuhawenimana@gmail.com",
                gender: "Male",
                picture: "images (9).jpg"
            },
            chats: [
                {
                    by: 'friend',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
                        date: '12/23/2019',
                        time: '12 :14'
            }
            },
                {
                    by: 'me',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'friend',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'friend',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'me',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                }
            ],
            posts: [
                {
                    image: 'images/profile/images (8).jpg',
                    caption: 'this is me'
                }
        ]
        },
        {
            profile: {
                firstName: "James",
                lastName: "Mahoro",
                email: "janviermuhawenimana@gmail.com",
                gender: "Male",
                picture: "images (10).jpg"

            },
            chats: [
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'me',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'me',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                }
            ],
            posts: [
                {
                    image: 'images/image1.jpg',
                    caption: 'hahahahahhahahahahahha'
                },
                {
                    image: 'images/image2.jpg',
                    caption: 'hahahahahhahahahahahha'
                },                {
                    image: 'images/image2.jpg',
                    caption: 'hahahahahhahahahahahha'
                },                {
                    image: 'images/image2.jpg',
                    caption: 'hahahahahhahahahahahha'
                },
                {
                    image: 'images/image3.jpg',
                    caption: 'hahahahahhahahahahahha'
                }
        ]
        },  {
            profile: {
                firstName: "Lucas",
                lastName: "KIZITO",
                email: "lucas@gmail.com",
                gender: "Male",
                picture: "images (3).jpg"

            },
            chats: [
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'me',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'me',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                }
            ],
            posts: []
        },  {
            profile: {
                firstName: "Manzi",
                lastName: "Pacifique",
                email: "mazi@gmail.com",
                gender: "Male",
                picture: "images (2).jpg"

            },
            chats: [
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'me',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'me',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                }
            ],
            posts: []
        },  {
            profile: {
                firstName: "Belise",
                lastName: "UWERA",
                email: "uwera@gmail.com",
                gender: "Female",
                picture: "images (4).jpg"

            },
            chats: [],
            posts: [
                {
                    image: 'images/profile/images (4).jpg',
                    caption: 'hahahahahhahahahahahha'
                }
        ]
        },  {
            profile: {
                firstName: "Aimerance",
                lastName: "momo",
                email: "janviermuhawenimana@gmail.com",
                gender: "Female",
                picture: "images (8).jpg"

            },
            chats: [
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                }],
            posts: []
        },  {
            profile: {
                firstName: "Kamanzi",
                lastName: "TURIKUMWE",
                email: "kamanzi@gmail.com",
                gender: "Male",
                picture: "images.jpg"

            },
            chats: [
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                } ],
            posts: [
                {
                    image: 'images/profile/images.jpg',
                    caption: 'hahahahahhahahahahahha'
                }
        ]
        },  {
            profile: {
                firstName: "James",
                lastName: "Mahoro",
                email: "janviermuhawenimana@gmail.com",
                gender: "Male",
                picture: "images (10).jpg"

            },
            chats: [
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                }],
            posts: [
                {
                    image: 'images/image1.jpg',
                    caption: 'hahahahahhahahahahahha'
                },
                {
                    image: 'images/image3.jpg',
                    caption: 'hahahahahhahahahahahha'
                }
        ]
        },  {
            profile: {
                firstName: "James",
                lastName: "Mahoro",
                email: "janviermuhawenimana@gmail.com",
                gender: "Male",
                picture: "images (10).jpg"

            },
            chats: [
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'me',
                    msg: ' hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'friend',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                },
                {
                    by: 'me',
                    msg: 'hello world we are recluting the people here on this challel',
                    date: {
            date: '12/23/2019',
            time: '12 :14'
}      
                }
            ],
            posts: [
                {
                    image: 'images/image1.jpg',
                    caption: 'hahahahahhahahahahahha'
                },
                {
                    image: 'images/image2.jpg',
                    caption: 'hahahahahhahahahahahha'
                },
                {
                    image: 'images/image3.jpg',
                    caption: 'hahahahahhahahahahahha'
                }
        ]
        }
    ]
}

// console.log(data);



window.postSlide = {
    slide: {
        curent: 0,
        max: 0
    },
    userPost: {
        curent: 0,
        max: 0
    },
    active: false

};


var dateTime = new Date();
// ALL THE USERS FROM THE DATABASE

window.DB = '';
// check if the users are loaded
window.dataLoaded = false;
// active user
window.USERS = {};
window.USER = {};
window.UID = sessionStorage.getItem("uid");

window.FRIENDS = {};
window.FRIENDS_ARRAY = [];
window.FRIENDS_GROUPS_ARRAY = [];
window.SELECTED = [];
window.CHATS = {};
window.ACTIVE_USERS = [];

window.STYLE_CHATS = {};
window.SELECTED_UID = null;
window.SELECTED_GROUP = null;
// load the datas
window.socket = null;

// chats definition
window.chatActive_Sound = null;
window.chat_Sound = null;

function loadMainData(callback) {
    axios.get('https://african-chat-app.firebaseio.com/users.json')
    .then((response) => {
        // handle success
        window.USERS = response.data;
        organizeData();
        callback('users data: ',response.data);
        
        // START OC CONNECTION WITH THE SOCKET







    })
    .catch(function (error) {
        
    })
    .finally(function () {

    });     
}

// find db
const findId = (id, success, from = window.USERS) => {
    let data = from;
    let found = false;
    for (const i in data) {
        let newOBJ = data[i];
        if (i == id) {
            found = true;
            newOBJ.key = i;
            // console.log(newOBJ);
            
            success(newOBJ);
            break;
        }
    }
    if (!found) {
        success({});
    }
}



const retId = (id) => {
    let data = window.USERS;
    let found = false;
    for (const i in data) {
        let newOBJ = data[i];
        if (i == id) {
            found = true;
            newOBJ.key = i;
            // console.log(newOBJ);
            
            return newOBJ;
            break;
        }
    }
    if (!found) {
        return {};
    }
}

// get user
const findDataDB = (key,value, success) => {
    let data = window.USERS;
    let found = false;
    for (const i in data) {
        let newOBJ = data[i];
        if (data[i][key] == value) {
            found = true;
            newOBJ.found = true;
            newOBJ.key = i;

            success(newOBJ);
            break;
        }
    }
    if (!found) {
        success({found: false});
    }
}



const generateFriendsList = (user) => {
    let newList = [];
    if (user.friends !== '') {
        for (var i in user.friends) {
            let subUser = user.friends[i];
            findId(subUser.friendKey, data => {
                subUser.details = data;
            });

            subUser.key = i;
            newList.push(subUser);
        }

        window.USER.oFriends = newList;        
    } else {
        window.USER.oFriends = newList;        
    }
}


            // console.log(retId(i));


function makeid(length) {
    var result           = '';
    var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for ( var i = 0; i < length; i++ ) {
       result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
 }
// const friendRequests = () => {
//     const friends = window.USERS;


//     for (const i in friends) {

//     }
// }

const inviteFriendDB = id => {
    // let chatKey = makeid(10);
    let messagesOBJ = {
        createdBy: window.UID,
        members: [window.UID, id]
    };

    loading(true);
    axios.post('https://african-chat-app.firebaseio.com/chats.json', messagesOBJ)
    .then((response) => {
        loading(false);

        let userOBJ_me = {
            friendKey: id,
            groupId: response.data.name,
            date: dateTime,
            accept: false
        }

        let userOBJ_friend = {
            friendKey: window.UID,
            groupId: response.data.name,
            date: dateTime,
            accept: false
        }
        
        // send group to the users
        axios.post(`https://african-chat-app.firebaseio.com/users/${id}/friends.json`,  userOBJ_friend);
        axios.post(`https://african-chat-app.firebaseio.com/users/${window.UID}/friends.json`,  userOBJ_me);
        
        // add the friend to the objsct
        loadMainData((data) => {
            findId(sessionStorage.getItem("uid"), user => {
                window.USER = user;
                generateFriendsList(user);
                chattList();
                organizeData(); 
            }, data);
            
            
            organizeData(); 
            generateFriendsList(user);
            chattList();
        })  
        if (this.USER.friends) {
            console.log('FOUND1');
        } else {
            console.log('NOT FOUND1');
        }
        console.log('USER: ', this.USER);        

    });
}


// console.log(window.UID);

// this will refresh the data
const refresh = () => {
    loading(true);
    axios.get('https://african-chat-app.firebaseio.com/users.json')
    .then((response) => {
        // handle success
        window.USERS = response.data;

        findId(sessionStorage.getItem("uid"), user => {
            
            window.USER = user;
            generateFriendsList(user);
            chattList();
            organizeData();
            // console.log('UPDATES: ', response.data);
            
        });

        
        // console.log
        loading(false);
    })
    .catch(function (error) {
        loading(false);
    })
    .finally(function () {

    });     
}



const organizeData = () => {
    // console.log('-----------------------------------');
    findId(window.UID, data => {
        // subUser.details = data;
        // window.FRIENDS_ARRAY =  Object.keys(window.USERS[window.UID].friends);    
        if (window.USERS[window.UID].hasOwnProperty('friends')) {      
            // get the users list
            let usersId = Object.keys(window.USERS[window.UID].friends);
            for (const key in usersId) {
                window.FRIENDS_ARRAY.push(window.USERS[window.UID].friends[usersId[key]].friendKey);
                window.FRIENDS_GROUPS_ARRAY.push(window.USERS[window.UID].friends[usersId[key]].groupId);
            }
        }
    });    
}


const styleMessages = (groupId, messages) => {
    // window.STYLE_CHATS
    const messagesBody = [];
    // console.log('Message from: ', groupId);
    // console.log('Messages: ', messages);
    // console.log('------------------------------------------');
    
    for (let [key, value] of Object.entries(messages)) {
        let body = value;
        body.key = key;
        messagesBody.push(body);
    }
    window.STYLE_CHATS[groupId] = messagesBody;
}

const storeMessage = message => {
    if (window.SELECTED_GROUP !== null || window.SELECTED_GROUP !== '') {
        if (window.SELECTED_GROUP in window.STYLE_CHATS) {
            window.STYLE_CHATS[window.SELECTED_GROUP].push(message);
        } else {
            window.STYLE_CHATS[window.SELECTED_GROUP] = [];
            window.STYLE_CHATS[window.SELECTED_GROUP].push(message);
        }
        return true;
    } else {
        return false;
    }
}


const storeMessageCashe = (message, groupId) => {
    if (groupId !== null || groupId !== '') {
        if (groupId in window.STYLE_CHATS) {
            window.STYLE_CHATS[groupId].push(message);
        } else {
            window.STYLE_CHATS[groupId] = [];
            window.STYLE_CHATS[groupId].push(message);
        }
        return true;
    } else {
        return false;
    }
}